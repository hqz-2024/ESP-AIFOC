# FOC 串口数据分析上位机

基于 PyQt5 的 FOC 电机控制串口调试工具，支持实时数据可视化、参数调整和自动同步。

---

## ✨ 主要功能

### 1. 实时数据监控
- 📊 传感器数据可视化（角度、速度、状态）
- 📈 电机数据可视化（速度、电压、电流设定值）
- ⚡ 电流数据可视化（三相电流、Q/D轴电流）

### 2. 参数控制
- 🎮 控制模式切换（速度/位置/电流）
- 🎯 目标值设置
- ⚙️ PID参数在线调整（速度环/位置环/电流环）
- 🔒 限制参数设置（电压/速度/电流）

### 3. **参数自动同步** ⭐ NEW
- ⏰ 定时自动同步参数到下位机（默认10秒）
- 🔄 手动立即同步
- 📊 同步状态实时显示
- 💾 同步设置可保存

### 4. 数据记录
- 📝 串口数据日志
- 💾 配置保存/加载
- 📋 协议解析（SENSOR/MOTOR/CURRENT/ACK）

---

## 🚀 快速开始

### 安装依赖

```bash
pip install -r requirements.txt
```

### 配置默认参数（可选）

在启动程序前，可以修改 `user_config.json` 设置默认参数：

```bash
# 用文本编辑器打开配置文件
notepad user_config.json

# 修改需要的参数，例如：
{
  "pid_velocity": {
    "p": 0.3,
    "i": 1.8,
    "d": 0.0,
    "lpf": 0.3
  },
  ...
}
```

详细说明请参考：[用户配置文件说明.md](./用户配置文件说明.md)

### 运行程序

```bash
cd src
python main.py
```

---

## 📖 使用说明

### 1. 连接设备

1. 选择串口（COM口）
2. 选择波特率（默认115200）
3. 点击"连接"

### 2. 参数设置

#### PID参数
- 切换到对应的PID标签页（速度/位置/Iq/Id）
- 输入P、I、D、LPF参数
- 点击"应用"按钮

#### 限制参数
- 设置电压限制（V）
- 设置速度限制（rad/s）
- 设置电流限制（A）
- 点击对应的"应用"按钮

### 3. 参数同步 ⭐

#### 自动同步
1. 勾选"启用自动同步"
2. 设置同步间隔（推荐10秒）
3. 程序会定时将所有参数同步到下位机

#### 手动同步
- 点击"立即同步"按钮
- 适用于需要立即应用参数的场景

#### 同步状态
- 🟢 绿色：同步成功
- 🟠 橙色：同步中/部分失败
- 🔴 红色：未连接/同步失败
- ⚪ 灰色：等待同步

### 4. 控制电机

1. 选择控制模式（VEL/POS/CURR）
2. 点击"设置模式"
3. 输入目标值
4. 点击"应用"

---

## 📁 文件结构

```
esp-serialdebug/
├── src/
│   ├── main.py              # 程序入口
│   ├── main_window.py       # 主窗口（含同步逻辑）
│   ├── control_panel.py     # 控制面板（含同步组件）
│   ├── serial_manager.py    # 串口管理
│   ├── protocol_parser.py   # 协议解析
│   ├── data_model.py        # 数据模型
│   ├── plot_widget.py       # 绘图组件
│   └── config.json          # 配置文件（自动生成）
├── docs/
│   └── FOC串口数据分析上位机开发文档.md
├── requirements.txt         # Python依赖
├── 参数自动同步功能说明.md  # 同步功能详细说明
└── README.md               # 本文件
```

---

## 🔧 配置文件

### 用户配置文件（user_config.json）⭐

**位置**：`esp-serialdebug/user_config.json`

**用途**：设置程序启动时的默认参数

**特点**：
- ✅ 启动前修改，设置默认值
- ✅ 支持所有PID参数、限制参数、同步设置
- ✅ 带注释说明，易于理解
- ✅ 适合不同电机的快速切换

**示例**：

```json
{
  "pid_velocity": { "p": 0.3, "i": 1.8, "d": 0.0, "lpf": 0.3 },
  "pid_angle": { "p": 20.0, "i": 0.0, "d": 0.0, "lpf": 0.05 },
  "pid_current_q": { "p": 1.0, "i": 3.0, "d": 0.0, "lpf": 0.005 },
  "pid_current_d": { "p": 1.0, "i": 3.0, "d": 0.0, "lpf": 0.005 },
  "limits": { "voltage": 11.0, "velocity": 50.0, "current": 3.0 },
  "sync": { "enabled": true, "interval": 10 }
}
```

详细说明：[用户配置文件说明.md](./用户配置文件说明.md)

---

### 运行时配置文件（config.json）

**位置**：`esp-serialdebug/src/config.json`（自动生成）

**用途**：保存程序运行时的参数修改

**特点**：
- ✅ 程序关闭时自动保存
- ✅ 下次启动时自动加载
- ✅ 优先级高于用户配置

**配置加载顺序**：

```
1. 加载 user_config.json（默认值）
2. 加载 config.json（覆盖默认值）
3. 用户手动修改参数
4. 关闭程序时保存到 config.json
```

---

## 📡 串口协议

### 下位机 → 上位机（数据帧）

```
SENSOR,<raw_angle>,4096,<deg>,<status>,<agc>,<magnitude>,<angle_rad>,<angle_deg_total>,<vel_rad_s>
MOTOR,<motor_angle_rad>,<motor_deg_total>,<motor_vel_rad_s>,<target_vel>,<voltage_q>,<voltage_d>,<current_sp>,<current_limit>
CURRENT,<ia>,<ib>,<ic>,<iq>,<id>
```

### 上位机 → 下位机（命令）

```
SET_MODE,<VEL|POS|CURR>
SET_TARGET,<value>
SET_PID,<VEL|ANG|IQ|ID>,<P>,<I>,<D>,<LPF>
SET_LIMIT,<VOLT|VEL|CURR>,<value>
STREAM,<ON|OFF>[,<interval>]
RELEASE
```

### 下位机 → 上位机（响应）

```
ACK,<CMD>,OK
ACK,<CMD>,ERR,<error_code>
```

---

## 💡 使用技巧

### 调试阶段
1. 禁用自动同步，手动调整参数
2. 使用"立即同步"应用参数
3. 观察电机响应，微调参数

### 稳定运行
1. 启用自动同步（间隔30-60秒）
2. 确保参数不会因意外丢失
3. 定期查看同步状态

### 参数调优
1. 先调整电流环（最内环）
2. 再调整速度环（中间环）
3. 最后调整位置环（最外环）
4. 每次调整后立即同步

---

## ⚠️ 注意事项

1. **同步间隔**：建议不低于5秒，避免下位机处理不过来
2. **串口连接**：仅在连接状态下才会执行同步
3. **参数范围**：注意PID参数和限制参数的合理范围
4. **日志查看**：所有操作都会记录在日志窗口

---

## 🐛 故障排除

### 串口连接失败
- 检查COM口是否正确
- 检查设备是否已连接
- 检查波特率是否匹配（115200）

### 参数同步失败
- 检查串口连接状态
- 查看日志窗口错误信息
- 尝试手动"立即同步"

### 数据不更新
- 检查下位机是否正常运行
- 检查STREAM是否开启
- 重新连接串口

---

## 📚 相关文档

- [用户配置文件说明](./用户配置文件说明.md) ⭐ 必读
- [参数自动同步功能说明](./参数自动同步功能说明.md)
- [FOC串口数据分析上位机开发文档](./docs/FOC串口数据分析上位机开发文档.md)

---

## 📝 更新日志

### v1.2.0 (2025-01-XX)
- ✅ 新增用户配置文件（user_config.json）⭐
- ✅ 支持启动前配置默认参数
- ✅ 配置文件分离（用户配置 + 运行时配置）
- ✅ 完善配置加载逻辑

### v1.1.0 (2025-01-XX)
- ✅ 新增参数自动同步功能
- ✅ 新增同步状态显示
- ✅ 更新默认PID参数值
- ✅ 优化配置保存/加载

### v1.0.0
- ✅ 基础串口通信
- ✅ 实时数据可视化
- ✅ PID参数调整
- ✅ 控制模式切换

---

## 📧 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- Email: your-email@example.com

