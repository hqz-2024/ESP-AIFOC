# FOC串口调试上位机 - 参数自动同步功能说明

## 📋 功能概述

新增了**参数自动同步**功能，可以定期将上位机的控制参数同步到下位机（ESP32），确保参数的一致性。

---

## 🎯 功能特性

### 1. **自动同步**
- ✅ 定时自动同步所有参数到下位机
- ✅ 可自定义同步间隔（5秒 - 5分钟）
- ✅ 默认间隔：10秒
- ✅ 可随时启用/禁用自动同步

### 2. **手动同步**
- ✅ 点击"立即同步"按钮手动触发同步
- ✅ 适用于需要立即应用参数的场景

### 3. **同步内容**
自动同步以下所有参数：

#### PID参数
- 速度环 PID (VEL)：P, I, D, LPF
- 位置环 PID (ANG)：P, I, D, LPF
- Q轴电流环 PID (IQ)：P, I, D, LPF
- D轴电流环 PID (ID)：P, I, D, LPF

#### 限制参数
- 电压限制 (VOLT)
- 速度限制 (VEL)
- 电流限制 (CURR)

### 4. **状态显示**
- ✅ 实时显示同步状态
- ✅ 颜色指示：
  - 🟢 绿色：同步成功
  - 🟠 橙色：同步中 / 部分失败
  - 🔴 红色：未连接 / 同步失败
  - ⚪ 灰色：等待同步

---

## 🖥️ 界面说明

### 参数同步面板

位于控制面板底部，包含以下控件：

```
┌─────────────────────────────┐
│      参数同步               │
├─────────────────────────────┤
│ ☑ 启用自动同步              │
│                             │
│ 同步间隔: [10] 秒           │
│                             │
│ [立即同步]                  │
│                             │
│ 状态: 同步成功              │
└─────────────────────────────┘
```

#### 控件说明

1. **启用自动同步** (复选框)
   - 勾选：启用定时自动同步
   - 取消勾选：禁用自动同步

2. **同步间隔** (数字输入框)
   - 范围：5 - 300 秒
   - 默认：10 秒
   - 修改后立即生效

3. **立即同步** (按钮)
   - 点击立即执行一次参数同步
   - 无论自动同步是否启用都可使用

4. **状态显示** (标签)
   - 显示当前同步状态
   - 颜色指示同步结果

---

## 📝 使用方法

### 基本使用流程

1. **连接串口**
   - 选择正确的COM口
   - 点击"连接"按钮

2. **配置参数**
   - 在各个PID面板中设置参数
   - 在限制参数面板中设置限制值

3. **启用自动同步**
   - 勾选"启用自动同步"
   - 设置合适的同步间隔（推荐10秒）

4. **观察同步状态**
   - 查看状态显示
   - 查看日志窗口的同步记录

### 手动同步

如果需要立即应用参数：
1. 修改参数后
2. 点击"立即同步"按钮
3. 等待同步完成（查看状态显示）

---

## 🔧 配置保存

同步设置会自动保存到 `config.json`：

```json
{
  "sync": {
    "enabled": true,
    "interval": 10
  }
}
```

下次启动时会自动加载这些设置。

---

## 📊 同步过程

### 同步流程

```
1. 检查串口连接
   ↓
2. 读取上位机所有参数
   ↓
3. 生成SET_PID和SET_LIMIT命令
   ↓
4. 依次发送命令（间隔50ms）
   ↓
5. 等待下位机ACK响应
   ↓
6. 更新同步状态
```

### 发送的命令示例

```
SET_PID,VEL,0.5,20.0,0.0,0.01
SET_PID,ANG,20.0,0.0,0.0,0.05
SET_PID,IQ,1.0,3.0,0.0,0.005
SET_PID,ID,1.0,3.0,0.0,0.005
SET_LIMIT,VOLT,11.0
SET_LIMIT,VEL,50.0
SET_LIMIT,CURR,3.0
```

---

## ⚠️ 注意事项

1. **同步间隔不宜过短**
   - 建议不低于5秒
   - 过短可能导致下位机处理不过来

2. **串口连接状态**
   - 仅在串口连接时才会执行同步
   - 断开连接时自动停止同步

3. **参数修改**
   - 修改参数后会在下次定时同步时自动应用
   - 如需立即应用，点击"立即同步"

4. **日志查看**
   - 所有同步操作都会记录在日志窗口
   - 可通过日志查看同步成功/失败情况

---

## 🐛 故障排除

### 同步失败

**问题**：状态显示"同步失败"或"部分失败"

**解决方法**：
1. 检查串口连接是否正常
2. 查看日志窗口的错误信息
3. 尝试手动点击"立即同步"
4. 重新连接串口

### 参数未生效

**问题**：修改参数后电机行为未改变

**解决方法**：
1. 点击"立即同步"强制同步
2. 检查日志确认命令已发送
3. 检查下位机是否正确接收ACK

---

## 💡 最佳实践

1. **启动时同步**
   - 连接串口后，点击"立即同步"确保参数一致

2. **调试时禁用自动同步**
   - 手动调试参数时，可暂时禁用自动同步
   - 避免自动同步覆盖手动设置

3. **正常运行时启用自动同步**
   - 长时间运行时启用自动同步
   - 确保参数不会因意外丢失

4. **合理设置间隔**
   - 调试阶段：5-10秒
   - 稳定运行：30-60秒

---

## 📈 更新日志

### v1.1.0 (2025-01-XX)
- ✅ 新增参数自动同步功能
- ✅ 新增同步状态显示
- ✅ 新增同步间隔设置
- ✅ 新增立即同步按钮
- ✅ 更新默认PID参数值
- ✅ 同步设置可保存/加载

