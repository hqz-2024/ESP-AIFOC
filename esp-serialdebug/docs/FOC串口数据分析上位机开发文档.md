# FOC 串口数据分析上位机开发文档

## 一、项目概述

本项目目标：使用 **Python + PyQt** 实现一个串口上位机工具，**连续高速接收下位机 FOC 电机控制相关数据，并以图形方式实时显示**，同时允许上位机下发控制模式与 PID/限幅参数，用于 FOC 调试与性能分析。

---

## 二、需求与功能整理

### 2.1 功能需求（上位机）

#### 2.1.1 串口通讯

- 串口参数配置：端口号、波特率（建议 115200 或更高）、数据位、校验、停止位
- 连接/断开串口；串口连接状态显示
- 显示原始日志/调试文本（便于观察协议问题）

#### 2.1.2 数据解析与实时显示

从串口持续接收下位机发来的文本数据，按协议解析出：

**AS5600 传感器信息：**
- 原始角度 `Raw Angle`
- 角度（度/弧度）
- 状态字节 `Status`
- AGC
- 磁场幅值 `Magnitude`
- 传感器角度、速度

**电机信息：**
- 电机角度、速度
- 目标速度
- 电压 Q/D（`Voltage Q / D`）
- 电流设定值与电流限制

**电流信息：**
- 三相电流 `Phase A/B/C`
- `Current Q`（转矩电流）
- `Current D`（励磁电流）

**图形显示：**
- 使用 PyQt 图形界面显示关键波形：
  - 角度、速度曲线
  - 电流 Q/D 变化
  - 三相电流波形
- 提供基本缩放、平移、暂停/继续绘图功能

#### 2.1.3 控制与参数调整

**控制模式选择：**
- 位置控制模式（Position）
- 速度控制模式（Velocity）
- 电流控制模式（Current/FOC）

**PID 与低通滤波参数下发（可调）：**

| 控制环路 | PID 参数 | 低通滤波 |
|---------|---------|---------|
| 速度环 | `PID_VELOCITY_P / I / D` | `LPF_VELOCITY_TF` |
| 位置环 | `PID_ANGLE_P / I / D` | `LPF_ANGLE_TF` |
| 电流环 Q | `PID_CURRENT_Q_P / I / D` | `LPF_CURRENT_TF` |
| 电流环 D | `PID_CURRENT_D_P / I / D` | `LPF_CURRENT_TF` |

**限制参数下发：**

| 参数 | 单位 |
|-----|------|
| `MOTOR_VOLTAGE_LIMIT` | V |
| `MOTOR_VELOCITY_LIMIT` | rad/s |
| `MOTOR_CURRENT_LIMIT` | A |

#### 2.1.4 配置与记录

- 将当前 PID/限幅配置保存为本地配置文件（JSON/INI 等），便于下次快速恢复
- 可选：支持数据记录为 CSV/二进制文件，供离线分析

### 2.2 非功能需求

- 接收/绘图延迟尽量低（近实时）
- 在高频数据下仍保持界面流畅（建议使用 `pyqtgraph`）
- 串口异常、断线时要有清晰提示，不崩溃

---

## 三、通讯协议设计（文本行协议）

### 3.1 物理层与编码约定

#### 3.1.1 物理层

- **介质**：UART 串口，通过 USB 转串口连接到上位机
- **默认串口参数（建议）**：

| 参数 | 值 |
|-----|-----|
| 波特率 | 115200（如数据量大可提升至 460800 / 921600） |
| 数据位 | 8 |
| 校验位 | None |
| 停止位 | 1 |
| 流控 | 无 |

#### 3.1.2 编码约定

- **字符集**：ASCII（或 UTF-8 兼容 ASCII 的子集）
- **消息格式**：一条消息为一行文本，以 `\r\n` 作为结尾
- **字段分隔**：使用英文逗号 `,` 分隔；键值对使用 `=` 表示

### 3.2 通用消息格式

所有上/下行消息统一采用：

```
<MSG_TYPE>,<字段1>,<字段2>,...,<字段N>\r\n
```

- `<MSG_TYPE>`：消息类型字符串，区分大小写，建议全部大写
  - 下位机上报：`SENSOR`, `MOTOR`, `CURRENT`
  - 上位机下发：`SET_MODE`, `SET_PID`, `SET_LIMIT` 等
- 数值字段：浮点数字或整数，**不带单位**，单位在协议文档中说明
- 可选键值格式：`SENSOR,raw=3076,deg=270.35,...`

### 3.3 下位机 → 上位机 数据帧规范

#### 3.3.1 传感器信息帧 `SENSOR`

- **帧类型**：`SENSOR`
- **发送周期**：与主控循环一致或稍低，典型 50–200 Hz

**字段定义：**

| 序号 | 字段名 | 类型 | 说明 | 示例 |
|-----|-------|------|------|------|
| 1 | `raw_angle` | int | 原始角度值 | 3076 |
| 2 | `raw_max` | int | 满量程计数 | 4096 |
| 3 | `deg` | float | 当前角度（度），0–360 | 270.35 |
| 4 | `status` | string | 状态字节（十六进制） | 0x27 |
| 5 | `agc` | int | AGC 值，0–255 | 93 |
| 6 | `magnitude` | int | 磁场幅值，0–4095 | 2085 |
| 7 | `angle_rad` | float | 累计角度（rad） | 11.0017 |
| 8 | `angle_deg_total` | float | 累计角度（度） | 630.35 |
| 9 | `vel_rad_s` | float | 角速度（rad/s） | 0.0000 |

**示例：**
```
SENSOR,3076,4096,270.35,0x27,93,2085,11.0017,630.35,0.0000\r\n
```

#### 3.3.2 电机信息帧 `MOTOR`

- **帧类型**：`MOTOR`

**字段定义：**

| 序号 | 字段名 | 类型 | 单位 | 说明 |
|-----|-------|------|------|------|
| 1 | `motor_angle_rad` | float | rad | 电机当前机械角（可累计） |
| 2 | `motor_deg_total` | float | ° | 电机当前角度（可累计） |
| 3 | `motor_vel_rad_s` | float | rad/s | 电机实际速度 |
| 4 | `target_vel_rad_s` | float | rad/s | 目标速度 |
| 5 | `voltage_q` | float | V | Q 轴电压 |
| 6 | `voltage_d` | float | V | D 轴电压 |
| 7 | `current_sp` | float | A | 当前设定电流 |
| 8 | `current_limit` | float | A | 当前电流限制 |

**示例：**
```
MOTOR,11.0017,630.35,0.0001,10.00,0.09,0.00,1.000,1.000\r\n
```

#### 3.3.3 电流信息帧 `CURRENT`

- **帧类型**：`CURRENT`

**字段定义：**

| 序号 | 字段名 | 类型 | 单位 | 说明 |
|-----|-------|------|------|------|
| 1 | `ia` | float | A | Phase A 电流 |
| 2 | `ib` | float | A | Phase B 电流 |
| 3 | `ic` | float | A | Phase C 电流 |
| 4 | `iq` | float | A | Q 轴电流（转矩电流） |
| 5 | `id` | float | A | D 轴电流（磁链电流） |

**示例：**
```
CURRENT,-0.003,0.003,0.000,0.119,0.007\r\n
```

#### 3.3.4 可选辅助帧

- `INFO`：文本信息、版本号、开机提示
- `ERROR`：错误代码、保护信息等

### 3.4 上位机 → 下位机 命令协议

#### 3.4.1 通用规则

- **命令格式**：`<CMD>,<参数1>,<参数2>,...\r\n`
- **数值单位约定**：

| 物理量 | 单位 |
|-------|------|
| 角度 | 弧度（rad） |
| 速度 | 弧度/秒（rad/s） |
| 电流 | 安培（A） |
| 电压 | 伏特（V） |

- **命令执行结果回执**：
  - 成功：`ACK,<CMD>,OK\r\n`
  - 失败：`ACK,<CMD>,ERR,<错误码>\r\n`

#### 3.4.2 控制模式设置

**设置控制模式：**

- **命令**：`SET_MODE`
- **格式**：`SET_MODE,<mode>\r\n`
- **mode 取值**：

| 值 | 说明 |
|----|------|
| `POS` | 位置控制 |
| `VEL` | 速度控制 |
| `CURR` | 电流控制（FOC 电流环） |

- **示例**：`SET_MODE,VEL\r\n`

**设置目标值：**

- **命令**：`SET_TARGET`
- **格式**：`SET_TARGET,<value>\r\n`
- **含义**：
  - 若当前模式为 `POS`：`value` 为目标位置（rad）
  - 若为 `VEL`：`value` 为目标速度（rad/s）
  - 若为 `CURR`：`value` 为目标 Q 轴电流（A）
- **示例**：`SET_TARGET,10.0\r\n`（速度模式，10 rad/s）

#### 3.4.3 PID 控制参数调整

- **命令**：`SET_PID`
- **格式**：`SET_PID,<loop>,<P>,<I>,<D>,<LPF_TF>\r\n`
- **loop 取值**：

| 值 | 说明 | 对应固件宏 |
|----|------|-----------|
| `VEL` | 速度环 | `PID_VELOCITY_*`, `LPF_VELOCITY_TF` |
| `ANG` | 位置环 | `PID_ANGLE_*`, `LPF_ANGLE_TF` |
| `IQ` | Q 轴电流环 | `PID_CURRENT_Q_*`, `LPF_CURRENT_TF` |
| `ID` | D 轴电流环 | `PID_CURRENT_D_*`, `LPF_CURRENT_TF` |

**示例对应关系：**

| 控制环 | 默认参数 | 命令示例 |
|-------|---------|---------|
| 速度环 | P=0.1, I=0.0, D=0.0, LPF=0.5 | `SET_PID,VEL,0.1,0.0,0.0,0.5\r\n` |
| 位置环 | P=0.2, I=10.0, D=0.0, LPF=0.01 | `SET_PID,ANG,0.2,10.0,0.0,0.01\r\n` |
| Q轴电流环 | P=0.1, I=0.0, D=0.0, LPF=0.005 | `SET_PID,IQ,0.1,0.0,0.0,0.005\r\n` |
| D轴电流环 | P=0.1, I=0.0, D=0.0, LPF=0.005 | `SET_PID,ID,0.1,0.0,0.0,0.005\r\n` |

**查询当前 PID 参数（可选）：**
- 命令：`GET_PID,<loop>\r\n`
- 返回：`PID,<loop>,<P>,<I>,<D>,<LPF_TF>\r\n`

#### 3.4.4 限制参数设置

- **命令**：`SET_LIMIT`
- **格式**：`SET_LIMIT,<type>,<value>\r\n`
- **type 取值**：

| 值 | 说明 | 对应固件宏 | 单位 |
|----|------|-----------|------|
| `VOLT` | 电压限制 | `MOTOR_VOLTAGE_LIMIT` | V |
| `VEL` | 速度限制 | `MOTOR_VELOCITY_LIMIT` | rad/s |
| `CURR` | 电流限制 | `MOTOR_CURRENT_LIMIT` | A |

**示例（默认值）：**
```
SET_LIMIT,VOLT,11.0\r\n
SET_LIMIT,VEL,50.0\r\n
SET_LIMIT,CURR,1.0\r\n
```

**查询限制参数（可选）：**
- 命令：`GET_LIMIT,<type>\r\n`
- 返回：`LIMIT,<type>,<value>\r\n`

#### 3.4.5 数据流控制（可选但推荐）

- **启动/停止连续上报数据**：
  - 命令：`STREAM,ON\r\n` / `STREAM,OFF\r\n`
  - 可选增加周期设置：`STREAM,ON,10\r\n` 表示 10ms 周期

#### 3.4.6 错误与异常处理

| 场景 | 回应 |
|------|------|
| 不支持的命令 | `ACK,<CMD>,ERR,UNSUPPORTED\r\n` |
| 参数超出范围 | `ACK,<CMD>,ERR,OUT_OF_RANGE\r\n` |
| 解析失败（格式错误） | `ACK,UNKNOWN,ERR,FORMAT\r\n` |

---

## 四、上位机软件架构设计（Python + PyQt）

### 4.1 模块划分建议

#### 4.1.1 串口通讯层

- **职责**：管理串口打开/关闭、参数设置、字节流收发
- **实现建议**：
  - 封装为独立类（例如 `SerialManager`），内部使用 `pyserial`
  - 使用线程或 `QThread` 循环读取串口数据，避免阻塞 UI

#### 4.1.2 协议解析层

- **职责**：将一行行文本解析为结构化数据对象
- **功能**：
  - 按 `\r\n` 分包，拆分 `MSG_TYPE` 与字段
  - 不同 `MSG_TYPE` 交给不同解析函数处理：
    - `parse_sensor()`
    - `parse_motor()`
    - `parse_current()`
  - 将解析后的数据放入线程安全队列或通过信号发送给 UI 层

#### 4.1.3 数据模型层

- **职责**：维护最近一段时间的历史数据，供绘图使用
- **内容**：
  - 时间戳序列（可以用 PC 接收时间）
  - 各物理量的数据缓存（角度、速度、电流、电压等）
  - 控制缓存长度（如最近 10 秒或最近 N 个点）

#### 4.1.4 可视化与 UI 层（PyQt + 图形库）

**主窗口布局：**
- 菜单/工具栏：串口连接、开始/停止、配置载入/保存
- 左侧/上部：控制面板（模式选择、目标值、PID 与限幅设置）
- 右侧/下部：波形显示区域（多图表或 Tab 分页）

**图形组件：**
- 推荐使用 `pyqtgraph` 实时绘图（性能好、与 PyQt 集成度高）
- 分别显示：
  - 角度/速度曲线
  - 电流 Q/D 曲线
  - 三相电流曲线

**日志窗口：**
- 显示原始串口文本，方便调试协议

#### 4.1.5 配置管理与记录

- 将当前参数（PID、限幅、串口设置等）保存在配置文件中
- 数据记录功能：将解析后的数据以 CSV 格式保存，便于后处理

### 4.2 线程与数据流

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  串口接收线程    │ ──► │   协议解析模块   │ ──► │   数据模型层    │
│  (阻塞读取)      │     │  (文本→结构体)  │     │   (缓存数据)    │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │    UI 更新      │
                                               │ (定时刷新波形)   │
                                               └─────────────────┘
```

- **串口接收线程**：从串口阻塞读取字节，拼接成一行行字符串，将完整行提交给协议解析模块
- **协议解析**：将文本帧解析为结构体（Python 字典/自定义对象），通过 Qt 信号或线程安全队列推送给主线程 UI
- **UI 更新**：每隔固定时间（如 20–50 ms）从数据模型取最新数据，刷新波形，控制更新频率避免绘图过慢导致卡顿

---

## 五、开发实施步骤

### 步骤 1：环境与基础库准备

- [ ] 选择 Python 版本（建议 3.9+）
- [ ] 安装 GUI 与通讯及绘图库：
  - PyQt5 或 PySide6
  - pyserial
  - pyqtgraph
- [ ] 在 PC 上通过串口调试工具（如 sscom、Putty）确认下位机数据流正常

### 步骤 2：确定串口通信协议最终版本

- [ ] 与下位机固件开发统一：
  - 波特率、串口参数
  - 数据上报格式：是否采用 `SENSOR/MOTOR/CURRENT` 文本协议
  - 上位机命令格式：`SET_MODE`、`SET_PID`、`SET_LIMIT` 等各字段顺序和单位
- [ ] 根据最终确认的协议完善《通讯协议文档》

### 步骤 3：实现串口通讯基础功能

- [ ] 编写串口管理类，实现：
  - 枚举串口，打开/关闭指定串口
  - 简单发送固定字符串命令（手动输入命令测试）
  - 连续读取串口，并在控制台或简单文本框中打印接收到的每一行

### 步骤 4：实现协议解析模块

- [ ] 编写解析函数：根据行首 `MSG_TYPE` 分发
- [ ] 将 `SENSOR/MOTOR/CURRENT` 转换为 Python 字典或数据类，字段名与单位清晰一致
- [ ] 做好异常处理：格式错误、字段数量不对时丢弃或记录错误

### 步骤 5：建立数据模型与缓存机制

- [ ] 为常用物理量设计数据缓存（如长度为 N 的列表或环形缓冲区）
- [ ] 为每种曲线（角度、速度、电流）定义对应的数据结构
- [ ] 设计更新策略：每次解析到一帧，立即更新对应缓存

### 步骤 6：搭建 PyQt 主界面框架

- [ ] 创建主窗口，布局：
  - 上部/左侧：串口连接区域（端口选择、波特率、连接按钮）
  - 中部：波形显示区域（使用 `pyqtgraph`）
  - 下部/右侧：控制面板（模式切换、目标值输入、PID 和限幅设置按钮）
- [ ] 将串口管理类与 UI 控件连通

### 步骤 7：集成实时绘图

- [ ] 将数据模型中的缓存数据，周期性刷新到 `pyqtgraph` 曲线
- [ ] 测试在高数据频率下的刷新性能，按需调整：
  - 刷新周期（如 20–50 ms）
  - 数据点数量上限（例如每条曲线显示最近 1000–2000 点）

### 步骤 8：实现命令下发与参数调整界面

- [ ] 在 UI 中加入：
  - 控制模式切换：对应发送 `SET_MODE` 命令
  - 目标值输入框：点击"应用"发送 `SET_TARGET`
  - PID 参数输入与应用按钮：发送 `SET_PID` 对应各环路
  - 限制参数输入与应用按钮：发送 `SET_LIMIT`
- [ ] 解析并显示下位机返回的 ACK 和错误信息

### 步骤 9：配置与数据记录功能

- [ ] 将当前 PID/限幅参数保存为配置文件，并支持加载
- [ ] 提供"开始记录 / 停止记录"按钮，将解析后的数据保存为 CSV

### 步骤 10：联调与优化

- [ ] 与实际下位机固件联调：
  - 核对各物理量单位与零点是否一致
  - 测试不同控制模式下的波形变化
  - 调试 PID 和限幅的调整效果
- [ ] 根据体验优化：
  - 增加曲线图例、单位标注
  - 某些量采用不同颜色/坐标轴
  - 增加异常状态提示（如磁铁丢失、过流等）

---

## 六、附录

### 6.1 推荐技术栈

| 组件 | 推荐选择 |
|-----|---------|
| Python 版本 | 3.9+ |
| GUI 框架 | PyQt5 / PySide6 |
| 串口库 | pyserial |
| 绘图库 | pyqtgraph |
| 配置文件 | JSON / INI |

### 6.2 参考资源

- [pyserial 文档](https://pyserial.readthedocs.io/)
- [PyQt5 文档](https://www.riverbankcomputing.com/static/Docs/PyQt5/)
- [pyqtgraph 文档](https://pyqtgraph.readthedocs.io/)

