# 串口通讯协议使用说明

## 概述

ESP32 FOC电机控制系统现已支持串口通讯协议，可与上位机进行数据交互和参数调整。

---

## 串口参数

| 参数 | 值 |
|-----|-----|
| 波特率 | 115200 |
| 数据位 | 8 |
| 校验位 | None |
| 停止位 | 1 |
| 流控 | 无 |

---

## 数据上报（下位机 → 上位机）

### 自动上报

下位机默认每100ms自动发送以下数据帧：

#### 1. 传感器数据帧 `SENSOR`

**格式：**
```
SENSOR,<raw_angle>,<raw_max>,<deg>,<status>,<agc>,<magnitude>,<angle_rad>,<angle_deg_total>,<vel_rad_s>\r\n
```

**示例：**
```
SENSOR,3076,4096,270.35,0x27,93,2085,11.0017,630.35,0.0000
```

**字段说明：**
- `raw_angle`: 原始角度值 (0-4095)
- `raw_max`: 满量程 (4096)
- `deg`: 当前角度（度，0-360）
- `status`: 状态字节（十六进制）
- `agc`: 自动增益控制值 (0-255)
- `magnitude`: 磁场幅值 (0-4095)
- `angle_rad`: 累计角度（弧度）
- `angle_deg_total`: 累计角度（度）
- `vel_rad_s`: 角速度（rad/s）

#### 2. 电机数据帧 `MOTOR`

**格式：**
```
MOTOR,<motor_angle_rad>,<motor_deg_total>,<motor_vel_rad_s>,<target_vel_rad_s>,<voltage_q>,<voltage_d>,<current_sp>,<current_limit>\r\n
```

**示例：**
```
MOTOR,11.0017,630.35,0.0001,10.00,0.09,0.00,1.000,1.000
```

**字段说明：**
- `motor_angle_rad`: 电机角度（弧度）
- `motor_deg_total`: 电机角度（度）
- `motor_vel_rad_s`: 电机速度（rad/s）
- `target_vel_rad_s`: 目标速度（rad/s）
- `voltage_q`: Q轴电压（V）
- `voltage_d`: D轴电压（V）
- `current_sp`: 电流设定值（A）
- `current_limit`: 电流限制（A）

#### 3. 电流数据帧 `CURRENT`

**格式：**
```
CURRENT,<ia>,<ib>,<ic>,<iq>,<id>\r\n
```

**示例：**
```
CURRENT,-0.003,0.003,0.000,0.119,0.007
```

**字段说明：**
- `ia`: A相电流（A）
- `ib`: B相电流（A）
- `ic`: C相电流（A）
- `iq`: Q轴电流/转矩电流（A）
- `id`: D轴电流/磁链电流（A）

---

## 命令下发（上位机 → 下位机）

### 1. 设置控制模式

**命令：** `SET_MODE,<mode>\r\n`

**参数：**
- `POS`: 位置控制
- `VEL`: 速度控制
- `CURR`: 电流控制

**示例：**
```
SET_MODE,VEL
```

**回应：**
```
ACK,SET_MODE,OK
```

### 2. 设置目标值

**命令：** `SET_TARGET,<value>\r\n`

**参数：**
- 位置模式：目标位置（rad）
- 速度模式：目标速度（rad/s）
- 电流模式：目标Q轴电流（A）

**示例：**
```
SET_TARGET,10.0
```

**回应：**
```
ACK,SET_TARGET,OK
```

### 3. 设置PID参数

**命令：** `SET_PID,<loop>,<P>,<I>,<D>,<LPF_TF>\r\n`

**loop参数：**
- `VEL`: 速度环
- `ANG`: 位置环
- `IQ`: Q轴电流环
- `ID`: D轴电流环

**示例：**
```
SET_PID,VEL,0.1,0.0,0.0,0.5
SET_PID,ANG,0.2,10.0,0.0,0.01
SET_PID,IQ,0.1,0.0,0.0,0.005
SET_PID,ID,0.1,0.0,0.0,0.005
```

**回应：**
```
ACK,SET_PID,OK
```

### 4. 设置限制参数

**命令：** `SET_LIMIT,<type>,<value>\r\n`

**type参数：**
- `VOLT`: 电压限制（V）
- `VEL`: 速度限制（rad/s）
- `CURR`: 电流限制（A）

**示例：**
```
SET_LIMIT,VOLT,11.0
SET_LIMIT,VEL,50.0
SET_LIMIT,CURR,3.0
```

**回应：**
```
ACK,SET_LIMIT,OK
```

### 5. 数据流控制

**命令：** `STREAM,<ON|OFF>[,<interval_ms>]\r\n`

**示例：**
```
STREAM,ON          # 启动数据流（默认100ms）
STREAM,OFF         # 停止数据流
STREAM,ON,50       # 启动数据流，50ms周期
```

**回应：**
```
ACK,STREAM,OK
```

### 6. 释放控制权

**命令：** `RELEASE,\r\n`

**说明：** 释放串口控制权，允许Web端控制

**示例：**
```
RELEASE,
```

**回应：**
```
ACK,RELEASE,OK
```

---

## 错误处理

### 错误回应格式

```
ACK,<CMD>,ERR,<错误码>
```

### 常见错误码

| 错误码 | 说明 |
|-------|------|
| `UNSUPPORTED` | 不支持的命令 |
| `FORMAT` | 格式错误 |
| `INVALID_MODE` | 无效的控制模式 |
| `INVALID_LOOP` | 无效的PID环路 |
| `INVALID_TYPE` | 无效的限制类型 |
| `OUT_OF_RANGE` | 参数超出范围 |

---

## 使用示例

### 示例1：切换到速度控制并设置目标速度

```
SET_MODE,VEL
SET_TARGET,10.0
```

### 示例2：调整速度环PID参数

```
SET_PID,VEL,0.2,20.0,0.0,0.01
```

### 示例3：设置电流限制

```
SET_LIMIT,CURR,5.0
```

### 示例4：调整数据上报频率

```
STREAM,ON,200
```

---

## 控制权管理

### 优先级规则

系统支持**Web端**和**串口上位机**两种控制方式，采用以下优先级规则：

| 控制源 | 优先级 | 说明 |
|-------|--------|------|
| 串口上位机 | **高** | 可随时抢占控制权 |
| Web端 | 低 | 仅在无其他控制源时可控制 |

### 控制权状态

- **无控制权**：任何控制源都可以获取控制权
- **串口控制中**：Web端无法控制，显示"控制权被占用"
- **Web控制中**：串口可随时抢占控制权

### 释放控制权

串口上位机可主动释放控制权：
```
RELEASE,
```

释放后，Web端可重新获取控制权。

### Web端提示

当串口占用控制权时，Web端会显示：
```
⚠️ 控制权限被占用
当前控制权被串口上位机占用
Web端仅可查看数据，无法控制电机
```

---

## 注意事项

1. **命令格式**：所有命令必须以 `\r\n` 结尾
2. **参数单位**：严格按照协议文档中的单位
3. **数据流**：默认启用，100ms周期
4. **实时性**：命令处理在主循环中，响应时间<10ms
5. **缓冲区**：命令长度不超过128字节
6. **控制权**：串口优先级高于Web端，可随时抢占

---

## 配置修改

如需修改默认数据上报周期，可在代码中修改：

```cpp
// main/src/serial_protocol.cpp
SerialProtocol::SerialProtocol(MotorControl* mc) 
    : motorControl(mc), cmdIndex(0), streamEnabled(true), 
      streamInterval(100),  // ← 修改这里（单位：ms）
      lastStreamTime(0) {
}
```

---

## 故障排查

### 问题1：收不到数据

- 检查串口参数是否正确（115200, 8N1）
- 检查数据流是否启用：发送 `STREAM,ON`

### 问题2：命令无响应

- 检查命令格式是否正确
- 检查是否有 `\r\n` 结尾
- 查看错误回应

### 问题3：数据更新太慢

- 调整数据流周期：`STREAM,ON,50`（50ms）
- 注意：周期太小可能影响FOC性能

---

## 开发建议

1. **上位机开发**：参考 `FOC串口数据分析上位机开发文档.md`
2. **协议扩展**：在 `serial_protocol.cpp` 中添加新命令
3. **调试**：使用串口调试工具（如sscom）测试命令

